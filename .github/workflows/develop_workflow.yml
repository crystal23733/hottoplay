name: Feature to Develop Automation Workflow

on:
  pull_request:
    branches:
      - "develop"
    types: [opened, synchronize, reopened]

jobs:
  client-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v3
      with:
        node-version: '22'

    - name: í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
      run: |
        cd client
        echo "${{ vars.ENV }}" > .env

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd client
        npm ci --legacy-peer-deps

    - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      id: test
      run: |
        cd client
        npm test

    - name: Next.js ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
      id: build
      run: |
        cd client
        npm run build

    - name: ì‹¤íŒ¨ ì‹œ ì´ìŠˆ ìƒì„±
      if: failure()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { repo, owner } = context.repo;
          const failedStep = steps.test.outcome === 'failure' ? 'í…ŒìŠ¤íŠ¸' : 'ë¹Œë“œ';
          await github.rest.issues.create({
            owner,
            repo,
            title: `ğŸš¨ í´ë¼ì´ì–¸íŠ¸ ${failedStep} ì‹¤íŒ¨ - PR #${context.payload.pull_request.number}`,
            body: `í´ë¼ì´ì–¸íŠ¸ ${failedStep} ê³¼ì •ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            \në¸Œëœì¹˜: ${context.payload.pull_request.head.ref}
            \nì»¤ë°‹: ${context.sha}
            \nì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë§í¬: ${process.env.GITHUB_SERVER_URL}/${owner}/${repo}/actions/runs/${context.runId}`,
            labels: ['ğŸ›ë²„ê·¸']
          });

  server-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Go ì„¤ì •
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Go ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
      id: build
      run: |
        cd server
        go build -v ./...

    - name: Go í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      id: test
      run: |
        cd server
        go test -v ./...

    - name: ì‹¤íŒ¨ ì‹œ ì´ìŠˆ ìƒì„±
      if: failure()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { repo, owner } = context.repo;
          const failedStep = steps.test.outcome === 'failure' ? 'í…ŒìŠ¤íŠ¸' : 'ë¹Œë“œ';
          await github.rest.issues.create({
            owner,
            repo,
            title: `ğŸš¨ ì„œë²„ ${failedStep} ì‹¤íŒ¨ - PR #${context.payload.pull_request.number}`,
            body: `ì„œë²„ ${failedStep} ê³¼ì •ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            \në¸Œëœì¹˜: ${context.payload.pull_request.head.ref}
            \nì»¤ë°‹: ${context.sha}
            \nì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë§í¬: ${process.env.GITHUB_SERVER_URL}/${owner}/${repo}/actions/runs/${context.runId}`,
            labels: ['ğŸ›ë²„ê·¸']
          });

  board-server-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Go ì„¤ì •
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Go ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
      id: build
      run: |
        cd board-server
        go build -v ./...

    - name: Go í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      id: test
      run: |
        cd board-server
        go test -v ./...

    - name: ì‹¤íŒ¨ ì‹œ ì´ìŠˆ ìƒì„±
      if: failure()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { repo, owner } = context.repo;
          const failedStep = steps.test.outcome === 'failure' ? 'í…ŒìŠ¤íŠ¸' : 'ë¹Œë“œ';
          await github.rest.issues.create({
            owner,
            repo,
            title: `ğŸš¨ ê²Œì‹œíŒ ì„œë²„ ${failedStep} ì‹¤íŒ¨ - PR #${context.payload.pull_request.number}`,
            body: `ê²Œì‹œíŒ ì„œë²„ ${failedStep} ê³¼ì •ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            \në¸Œëœì¹˜: ${context.payload.pull_request.head.ref}
            \nì»¤ë°‹: ${context.sha}
            \nì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë§í¬: ${process.env.GITHUB_SERVER_URL}/${owner}/${repo}/actions/runs/${context.runId}`,
            labels: ['ğŸ›ë²„ê·¸']
          });

  powerball-lambda-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Go ì„¤ì •
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Go ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
      id: build
      run: |
        cd powerball-lambda
        go build -v ./...

    - name: Go í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      id: test
      run: |
        cd powerball-lambda
        go test -v ./...

    - name: ì‹¤íŒ¨ ì‹œ ì´ìŠˆ ìƒì„±
      if: failure()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { repo, owner } = context.repo;
          const failedStep = steps.test.outcome === 'failure' ? 'í…ŒìŠ¤íŠ¸' : 'ë¹Œë“œ';
          await github.rest.issues.create({
            owner,
            repo,
            title: `ğŸš¨ íŒŒì›Œë³¼ ëŒë‹¤ ${failedStep} ì‹¤íŒ¨ - PR #${context.payload.pull_request.number}`,
            body: `íŒŒì›Œë³¼ ëŒë‹¤ ${failedStep} ê³¼ì •ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            \në¸Œëœì¹˜: ${context.payload.pull_request.head.ref}
            \nì»¤ë°‹: ${context.sha}
            \nì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë§í¬: ${process.env.GITHUB_SERVER_URL}/${owner}/${repo}/actions/runs/${context.runId}`,
            labels: ['ğŸ›ë²„ê·¸']
          });

  auto-merge:
    needs: [client-validation, server-validation, board-server-validation, powerball-lambda-validation]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: PR ìë™ ë³‘í•©
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const PullRequestService = require('./.github/actions/services/PullRequestService');
          const MergeService = require('./.github/actions/services/MergeService');

          async function run() {
            const prService = new PullRequestService(github, context);
            const mergeService = new MergeService(github, context);

            try {
              const { data: pullRequest } = await prService.getPullRequest(context.payload.pull_request.number);
              const validation = prService.validatePullRequest(pullRequest);
              await mergeService.mergePullRequest(context.payload.pull_request.number, validation);
              
              console.log(`PR #${context.payload.pull_request.number} ë³‘í•©ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
              console.error('ë³‘í•© í”„ë¡œì„¸ìŠ¤ ì˜¤ë¥˜:', error);
              core.setFailed(error.message);
            }
          }

          run();