name: Feature to Develop Automation Workflow

on:
  pull_request:
    branches:
      - "develop" # develop 브랜치로 PR 생성 시 실행

jobs:
  build-and-test:
    runs-on: ubuntu-latest # 워크플로 실행 환경

    steps:
    - name: Checkout code
      uses: actions/checkout@v4 # 코드 체크아웃

    - name: Set up Node.js
      uses: actions/setup-node@v3 # Node.js 환경 설정
      with:
        node-version: '22'

    - name: Install dependencies (Next.js)
      run: |
        cd client
        npm ci # 의존성 설치

    - name: Build Next.js application
      run: |
        cd client
        npm run build # Next.js 빌드

    - name: Set up Go
      uses: actions/setup-go@v4 # Go 환경 설정
      with:
        go-version: '1.23' # 사용할 Go 버전

    - name: Build Go application
      run: |
        cd server
        go build -v ./... # Go 서버 빌드

    - name: Run Go tests
      run: |
        cd server
        go test -v ./... # Go 테스트 실행

  auto-merge:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4 # 코드 체크아웃

    - name: Auto-merge PR into develop
      uses: actions/github-script@v6
      with:
        script: |
          const { data: pullRequest } = await github.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.pull_request.number
          });

          // 조건: PR 대상이 develop이고, source 브랜치가 feature/로 시작
          if (
            pullRequest.base.ref === 'develop' &&
            pullRequest.head.ref.startsWith('feature/') &&
            pullRequest.mergeable &&
            pullRequest.mergeable_state === 'clean'
          ) {
            await github.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              merge_method: "squash" # "merge", "squash", 또는 "rebase" 중 선택
            });
            console.log(`PR #${pullRequest.number} merged into ${pullRequest.base.ref}`);
          } else {
            console.log(`PR #${pullRequest.number} does not meet merge criteria.`);
            core.setFailed("Merge criteria not met.");
          }